

## 《RN8213/RN8211B 系列电表校准工具 v2.0 → PyQt5 单页版》需求规格说明书（修订版）

  

> 适用来源：你提供的 `/mnt/data/RN8211B V3校表计算.xlsx` 的 **v2.0** sheet（以下简称“模板”）。  

> 基本定位：**单页** GUI、**菜单式参数输入**、**串口下发逐步校表/一键校表**、**仅 Excel 存档**。  

> 目标人群：产线工人（日常操作）、工程师（参数维护）。  

> 技术基线：**PyQt5 + pyserial + openpyxl**，不使用数据库，不引入花里胡哨的栈。

  

___

  

## 1\. 项目背景与范围

  

-   现状：模板中已经把“校表流程、工程师参数、报文构造（DL/T645 家族特征极为明显）、校验和、0x33 偏置”等逻辑塞在一个 Excel 页面内，工人手动改值、抄数、点计算，过程脆弱、易错。

-   目标：把模板映射为**一个 PyQt5 桌面程序**：

    -   **单页 UI** 容纳全部流程项（勾选步骤 + 单步操作 + 一键校表）。

    -   **菜单**中承载“标准值输入”、“串口配置”、“工程师参数维护”、“Excel 导入/导出模板”、“关于/帮助”。

    -   **串口通讯**作为第一公民：每一步都**组帧下发**、**等待响应**、**验收帧结构/校验和/控制码/数据域**，失败可重试，全部写**Excel 日志**。

    -   **存档只用 Excel**：操作过程、帧日志、校表结果全部写入一个工作簿的不同 sheet；**不使用数据库**。

-   非目标：

    -   不做自动识别工装、台体、条码枪之类硬件拓展；

    -   不做网络化/云端；

    -   不做多机并发控制；

    -   不做脚本扩展引擎（后续再想）。

  

___

  

## 2\. 名词与约定

  

|   名词    |                                含义                                |

|---------|------------------------------------------------------------------|

|   模板    |                          你给的 v2.0 sheet                          |

|  校表步骤   | 模板中列示的五大类：1）电流有效值 offset；2）1.0L 电压/电流增益；3）功率增益；4）相位补偿；5）小电流下有功偏置 |

| 0x33 偏置 |           DL/T 645 族的典型数据域变换：发送时各字节 +0x33，接收/解析时 −0x33           |

|   CS    |              校验和：从第二个 0x68 起到数据域末尾所有字节的**算术和** mod 256               |

|  一键校表   |                  由用户勾选步骤清单后，按序自动执行；可在失败时停下或自动重试                  |

  

___

  

## 3\. 关键业务变更（你指出的六条修正，一条不落）

  

1.  **取消“逐步引导页”**：不是巫术；**所有流程放在同一主界面**。用户可：

    -   勾选要执行的步骤（多选框）；

    -   点“一键校表”（按勾选顺序全自动执行）；

    -   或逐步点“执行此步”按钮；

    -   或手动只跑任意单步。

2.  **只用 Excel 存档**：不许数据库。导入/导出模板、写日志、写结果，全部在一个工作簿内搞定（openpyxl）。

3.  **每一步都要组帧下发 + 验回包**：必须提供**串口选择与参数配置**；每个步骤执行即刻出/入包验证，失败记录重试与原因。

4.  **标准值与串口配置放在菜单**：主界面不堆废物输入框；**菜单中弹窗**配置/输入，确认后主界面仅显示摘要。

5.  **UI 框架锁死 PyQt5**：不争论；所有界面基于 Qt Designer 可复用布局思想，减少你们写代码量。

6.  **程序尽量简单**：模块边界清晰、逻辑内核独立、代码文件少、无黑魔法，保留**最少依赖**（PyQt5、pyserial、openpyxl）。

  

___

  

## 4\. 功能结构与界面信息架构

  

### 4.1 单页主界面布局（核心面板）

  

|   区域    |                          内容                           |     交互      |

|---------|-------------------------------------------------------|-------------|

|  顶部工具条  |     「一键校表」按钮；「开始串口」/「关闭串口」；「刷新端口」；当前端口状态灯（绿/灰/黄）      | 一键触发 / 状态显示 |

| 左侧：步骤清单 |       5 大步骤（复选框）+ 每步右侧**执行按钮**；每步下方显示**最近一次结果/时间/响应码**        |   勾选/单步执行   |

| 右侧：过程日志 |        滚动文本区：**Tx/Rx 原始帧（十六进制空格分隔）**、校验和、判定、耗时、异常         |    自动追加     |

|  底部状态栏  | 串口参数摘要（COMx, 波特率, 数据位, 校验, 停止位, 超时）；标准值摘要（U/I/功率误差模式） |     只读      |

  

> 所有输入都塞回菜单，主界面只负责执行与观察。逻辑上干净利落，不给工人多余的错误机会。

  

### 4.2 顶部菜单

  

-   **文件**：

    -   载入模板（打开 Excel）

    -   导出记录（将“操作记录/帧日志/结果”写入 Excel）

    -   退出

-   **通讯**：

    -   串口配置（弹窗：端口列表、波特率、数据位、校验位、停止位、超时、重试次数、间隔）

    -   端口探测（扫描可用串口）

-   **参数**：

    -   **标准值输入**（弹窗：标准电压 V、标准电流 A、功率误差%（仅误差模式显示）、是否启用误差模式）

    -   **工程师参数**（弹窗：仅工程师密码可进；见第 6 节）

-   **自动化**：

    -   步骤模板管理（保存/载入一组步骤勾选方案）

    -   执行策略（失败是否中止/是否重试 N 次/单步间隔）

-   **帮助**：

    -   使用说明 / 快速上手

    -   关于（版本、提交号）

  

___

  

## 5\. 串口通讯需求（必须明确，否则产线现场一定翻车）

  

### 5.1 参数与默认值

  

|  项  |          取值与默认          |

|-----|-------------------------|

| 端口  |    枚举系统串口（按平台），由用户选     |

| 波特率 | 建议候选：**2400（默认）/4800/9600** |

| 数据位 |        7 或 **8（默认）**        |

| 校验位 |     **Even（默认）** / None     |

| 停止位 |        **1（默认）** / 2        |

| 读超时 |     **1500 ms（默认）**，可调      |

| 写超时 |       500 ms（默认）        |

| 重试  |         默认 2 次          |

| 间隔  |     帧与帧间隔默认 200 ms      |

  

> 以上默认取 DL/T 645 设备常见参数习惯值；你若非要另改，也请写死在“工程师参数”或串口配置里。

  

### 5.2 基本流程

  

1.  打开串口 → 成功后状态灯变绿，配置摘要写入状态栏；

2.  任一“执行此步/一键校表”操作：

    -   构造请求帧（见第 7 章），写串口；

    -   启动读：直到**读到 0x68**（帧起始），解析**地址/第二个 0x68/控制码/长度 L**，读取 **L + 1（CS） + 1（0x16）** 字节；

    -   校验 CS；校验控制码是否为**应答/回包**对应值；若错误或超时，重试/中止按策略执行；

    -   解析数据域（必要时做 **−0x33** 反偏置），提取关键信息用于判定本步是否通过；

    -   记录**Tx/Rx 十六进制**、耗时、判定结果、异常信息到日志区与 Excel。

3.  关闭串口：写入一次“会话终止”记录。

  

___

  

## 6\. 参数体系

  

### 6.1 标准值（菜单→参数→标准值输入）

  

|    字段    |      说明       |

|----------|---------------|

| 标准电压 (V) |    例如 220V    |

| 标准电流 (A) | 例如 64A 或产线要求值 |

| 功率误差 (%) | 仅“误差校准模式”下可见  |

|  误差校准模式  |      开/关      |

  

-   合法性：范围检查（U：90–300V，I：0–200A，误差：±10%），越界给出红色提示，不允许保存。

-   保存后，主界面底部状态栏显示摘要。

  

### 6.2 工程师参数（菜单→参数→工程师参数；受密码保护）

  

从模板 **“工程师设置区 (生产时请锁定或隐藏这些列)”** 抽取，作为只读/可改字段（可导入/导出为 Excel 的“参数”sheet）。示例项（根据模板数据结构）：

  

|        参数项目         |  设定值（示例）  |  单位  |          备注          |

|---------------------|-----------|------|----------------------|

|       基准电压 Un       |    220    |  V   |          —           |

|     电压分压总电阻 Ra      | `=180*6*1000` |  Ω   |      公式来源：模板 F5      |

|      电压采样电阻 Rt      |   （数值）    |  Ω   |          —           |

|      电流分流电阻 Ri      |   （数值）    | μΩ/Ω |   模板中“(即250μΩ)”等备注   |

| 电压/电流通道增益 Upga/Ipga |   （数值）    |  —   |          —           |

|    电表常数 imp/kWh     |   （数值）    |  —   |          —           |

|      高频时钟 fd2f      |   （数值）    | MHz  | 模板备注“(手册为0.9216MHz)” |

  

> 这些参数只用于**计算与参考**，以及决定各步的目标写入值（若你的寄存器算法依赖它们）。任何更改都写入 Excel 配置。

  

___

  

## 7\. 报文协议与组帧方法（依据模板公式反推，DL/T 645 家族样式）

  

### 7.1 帧结构（请求/响应）

  

```

<div><p>mathematica</p><p><code>68 A5 A4 A3 A2 A1 A0 68 C L DATA CS 16</code></p></div>

```

  

|  字段   |                        说明                         |

|-------|---------------------------------------------------|

|  68   |                        起始符                        |

| A5…A0 |             表地址，6 字节（低位在前的显示与存储问题见下）              |

|  68   |                       第二起始符                       |

|   C   |             控制码（请求通常为写/读等；模板中出现 **0x14**）             |

|   L   |                     数据长度（字节数）                     |

| DATA  | 数据域：通常含 **数据标识（DI 4B）** +（密码/操作者码）+ 业务数据；**发送时每字节 +0x33** |

|  CS   |         校验和：从第二个 0x68 到数据域最后一字节求和 mod 256         |

|  16   |                        结束符                        |

  

**模板证据**

  

-   `B25 = "68 11 11 11 11 11 11 68 14"`（起始、地址全 0x11、控制码 0x14）

-   `B26 = "33333333"`，`B27 = 34333333`（明显是“密码/操作者码”等 8 位十六进制文本，字符“3”并非数值 0x33，但与 0x33 偏置语义强相关）

-   `C39 = "00F81500"`（**数据标识 DI** 原码，8 位十六进制文本）

-   `D39 = CONCAT(RIGHT(C39,2), MID(C39,5,2), MID(C39,3,2), LEFT(C39,2))`（**字节序翻转：gh ef cd ab**）

-   `E39` / `E42`：**LET** 实现，对无空格字串逐字节\*\*+0x33 偏置\*\*并 HEX 输出（Excel 365 新函数，模板可见 `_xlfn.LET(... +51, 256)`）

-   `C36 = DEC2HEX(MOD(SUM(HEX2DEC(MID(B36,...,2))),256),2)`（**校验和 CS** 计算）

-   `C34 = IF(LEN(DEC2HEX(LEN(B34)/2+12))=1,"0"&..., DEC2HEX(...))`（**长度 L** 计算）

  

> 结论：模板明确走的是“**DI 小端排列**→**+0x33 偏置**→组帧→**CS**”，完全符合 DL/T 645 风格。

  

### 7.2 关键公式（原文摘录）

  

> 以下为模板中抓到的代表性公式（坐标→公式/含义）。你要全文列出，我当然奉陪。

  

-   **F5**（工程师区：电压分压总电阻）  

    `=180*6*1000`  

    含义：6 组 180kΩ 串并形式合成（具体电路拓扑你自己心里有数），得 Ra。

-   **B32**（整帧拼接）  

    `=SUBSTITUTE(B25&C34&E39&B26&B27&B34&C36&16," ","")`  

    含义：将各段十六进制文本拼接，并去空格，最终得到**发送帧文本**。

-   **B34**（数据域拼接）  

    `=SUBSTITUTE(E42&E43&E44&E45&E46&E47," ","")`  

    含义：拼接经 +0x33 偏置的各段数据域（多段 E42..E47）。

-   **C34**（长度 L 计算）  

    `=IF(LEN(DEC2HEX(LEN(B34)/2+12))=1,"0"&DEC2HEX(LEN(B34)/2+12),DEC2HEX(LEN(B34)/2+12))`  

    含义：**L = 数据域字节数 + 12**（模板定义；与“密码/操作者/DI”等总字节构成叠加），十六进制两位补零。

-   **D39**（DI 字节序翻转）  

    `=CONCATENATE(RIGHT(C39,2)," ",MID(C39,5,2)," ",MID(C39,3,2)," ",LEFT(C39,2))`

-   **E39**（对 D39 的字节做 +0x33 偏置）  

    公式在模板里以 `LET(...)` 形式存在，核心逻辑：

    -   去空格；

    -   逐字节 `HEX2DEC`→`+0x33 (十进制 51)`→`MOD(…,256)`→`DEC2HEX(2位)`；

    -   `TEXTJOIN` 拼回。

-   **B36**（参与 CS 的拼接段）  

    `=SUBSTITUTE(B25&C34&E39&B26&B27&B34," ","")`

-   **C36**（CS 校验和）  

    `=DEC2HEX(MOD(SUM(HEX2DEC(MID(B36,(ROW(INDIRECT("1:"&LEN(B36)/2))-1)*2+1,2))),256),2)`

-   **B35**（另一种数据域拼接形式）  

    `=SUBSTITUTE(D47&D46&D45&D44&D43&D42," ","")`

-   **B42=0, C42=DEC2HEX(B42,2), D42=RIGHT(DEC2HEX(B42,8),2), E42=LET(... +51 ...)**  

    意味着此段业务数据**来自十进制输入**，再变换为 HEX，翻取低字节等，再做 +0x33 偏置，最后参与 B34 数据域的拼接。

  

> 综上，**组帧步骤顺序**为：  

> 1）`C39` 取 DI 原码 → `D39` 翻字节序 → `E39` 加 0x33；  

> 2）若有数值参数：`B42 → C42 → D42 → E42`… 生成偏置后的数据片段；  

> 3）`B34` 拼 E42..E47；  

> 4）`C34` 计算长度；  

> 5）`B36` 拼装（不含 CS 与 0x16）；  

> 6）`C36` 计算 CS；  

> 7）`B32` 最终帧 = 头 + L + DI偏置 + 密码/操作者 + 数据域偏置 + CS + 16。

  

### 7.3 发送/接收验收规则

  

-   **发送**：将 `B32` 的连续十六进制文本转成字节数组写串口；

-   **接收**：

    -   搜索首个 `0x68`；

    -   读取 6 字节地址 + `0x68` + 控制码 + 长度 L；

    -   再读 **L + 2**（**CS** + `0x16`）；

    -   **验 CS**：求和比较；

    -   **验控制码**：是否为期望的应答类型；

    -   **验长度**：与数据实际一致；

    -   **必要时数据域 −0x33 反偏置**，还原业务值；

    -   失败 → 按策略重试/中止，并记录 Excel。

  

> 响应成功的判定由**每步的业务含义**决定：例如写成功码、或回读值在容差内。

  

___

  

## 8\. 校表步骤定义（单页多选 + 单步执行 + 一键校表）

  

> 你不要流程引导页，那就全部摊平在一页；每一步都有\*\*「执行」**按钮、**最近一次结果**、**耗时**，并可在顶部「一键校表」按**勾选顺序\*\*自动执行。

  

### 8.1 通用字段

  

|   字段   |                       含义                       |

|--------|------------------------------------------------|

|  步骤名称  |               如“电流有效值 offset 校正”               |

|   依赖   |             是否依赖“标准值输入”或“前置步骤已完成”              |

|   DI   |          **数据标识**（从模板中 C39 等获取或工程师参数中配置）           |

|  业务数据  | 写入的数值（源自标准值/计算/工程师参数），经 `→ 十六进制 → 字节序处理 → +0x33` |

|  控制码   |       默认 `0x14`（模板痕迹），如读用 `0x11/0x01` 之类按需配置       |

| 密码/操作者 |         `B26/B27` 等（模板形式为 8 位文本，与厂标一致即可）         |

|   验收   |       收到应答并通过“CS/控制码/长度”校验，以及**读回确认**或**成功码**符合        |

  

> **DI 的来源**：模板示例 `C39="00F81500"`。你们若有每步的具体 DI 清单（例如增益寄存器、相位补偿寄存器、小电流偏置寄存器等），就放进“工程师参数→寄存器映射”里；此处不瞎编厂内私有地址。

  

### 8.2 步骤一：电流有效值 offset 校正（空载）

  

-   目的：在空载下把电流有效值的偏移归零/在阈值内。

-   输入：标准值（空载默认 I=0），工程师阈值（可选）。

-   报文：按本步 DI 构造写命令；数据域为**目标 offset 值**（十进制→HEX→字节序→+0x33）。

-   验收：读回 offset 或接收成功应答后再**主动读回**，数值应在阈值内。

  

### 8.3 步骤二：1.0L 标准电压/电流增益校正

  

-   目的：在标准台体 1.0L（额定负载）下，校正 U/I 增益寄存器。

-   输入：标准 U（如 220V）、标准 I（如 64A）、工程师增益限幅。

-   报文：写 U 增益、写 I 增益（两次写或一次多寄存器写，视 DI 定义）。

-   验收：读回增益并**重新测量**（或从台体读数人工确认），误差入阈。

  

### 8.4 步骤三：功率增益校正

  

-   目的：修正有功功率计量增益，使计量常数/脉冲对应一致。

-   输入：标准功率（由 U×I 与功率因数推导），或直接输入**功率误差%**（启用“误差模式”时）。

-   报文：写功率增益/常数寄存器。

-   验收：回读/复测合格。

  

### 8.5 步骤四：相位补偿校正

  

-   目的：在增益一致性处理后，做细相位补偿，使功率因数与相位误差收敛。

-   报文：写相位补偿寄存器（数据域是角度/相位码）。

-   证据：模板 F34 旁备注：“**理由：在增益全部校准后，解决相位问题。**”

-   验收：回读 + 误差检查。

  

### 8.6 步骤五：小电流下有功偏置校正

  

-   目的：在小电流条件下抑制有功偏置（死区/零漂）。

-   报文：写偏置寄存器。

-   验收：回读 + 复测小电流工况。

  

> 以上五步的**具体 DI/数据格式**请放入“工程师参数→寄存器映射”（Excel sheet），程序只负责**根据映射表组帧**，不在代码里硬编码你们的私有寄存器号，免得将来改一次全线崩。

  

___

  

## 9\. 组帧引擎（程序内部算法规范）

  

### 9.1 字段来源映射表（Excel → 内存）

  

| 名称 | Excel 字段/公式 | 说明 |  

|---|---|  

| 头部字段 | `B25` | 如 `68 11 11 11 11 11 11 68 14` |  

| DI 原码 | `C39` | 例如 `00F81500` |  

| DI 小端 | `D39` | 将 `C39` 依 `gh ef cd ab` 排列 |  

| DI 偏置 | `E39` | `D39` 每字节 +0x33 后拼接 |  

| 业务参数（十进） | `B42…B47` | 原始十进值 |  

| 业务参数（HEX/取低字节等） | `C42…D47` | `DEC2HEX` 与取位 |  

| 业务参数偏置 | `E42…E47` | 对 `D42…D47` 每字节 +0x33 |  

| 数据域（偏置后） | `B34` | 拼 `E42…E47` |  

| 长度 L | `C34` | `LEN(B34)/2 + 12` 转两位 HEX |  

| CS | `C36` | 标准求和 mod 256 |  

| 完整帧 | `B32` | 拼接所有段并去空格 |

  

> 程序并不“照抄”单元格，而是**用相同算法**生成同样结果。Excel 仅作为**权威算法样例**与导入参数来源。

  

### 9.2 算法（与 Excel 等价）

  

-   **字节序翻转（DI）**：输入 8 位 HEX 字符串 `abcdefgh` → 输出 `"gh ef cd ab"`（带空格）；实现如模板 `D39`。

-   **+0x33 偏置**：对每个字节 `b`：`b' = (b + 0x33) & 0xFF`，输出两位大写 HEX。

-   **长度 L**：`L = data_len + 12`（与模板保持一致；若后续你们模板改了，程序在“工程师参数→报文模板规则”里可配置）。

-   **CS**：对 **从第二个 0x68** 开始直到**数据域最后一字节**全部字节做 `sum & 0xFF`，输出两位 HEX（大写，补零）。

  

___

  

## 10\. 响应解析与判定

  

-   **定位**：首个 `0x68`；

-   **读取**：`addr(6) + 68 + C + L + DATA(L) + CS + 16`；

-   **验证**：

    -   起止符是否 `68`/`16`；

    -   CS 是否一致；

    -   控制码是否为期望回包（写→写应答，读→读应答）；

    -   短包/超时/断流：直接记失败，进入重试；

    -   数据域解析：如果需反偏置，逐字节 `b = (b' - 0x33) & 0xFF`。

-   **业务判定**：

    -   写成功：看**应答码/状态位**；

    -   读确认：解析值在容差内；

    -   任一步失败 → 按“自动化策略”决定是停、还是重试 N 次。

  

___

  

## 11\. Excel 存档与结构（只用 Excel）

  

### 11.1 工作簿结构（建议）

  

| Sheet |        用途        |              字段              |

|-------|------------------|------------------------------|

|  `参数`   | 工程师参数/寄存器映射/报文规则 |    参数表、DI 映射、密码/操作者、长度规则等    |

|  `记录`   |  每次校表记录（一键或单步）   |     时间、操作员、型号/批次、步骤集、结论      |

|  `帧日志`  | 原始 Tx/Rx 框 + 判定  | 时间、步骤、TxHex、RxHex、CS校验、耗时、异常 |

|  `结果`   |      每步最终数值      |     步骤名、目标值、读回值、阈值、是否通过      |

  

> 程序启动可载入 `参数`；执行完毕**追加**写入 `记录/帧日志/结果`。全部在**同一个**文件内。

  

### 11.2 导入/导出

  

-   **导入模板**：允许用户选择一个 Excel 作为“当前参数来源”，程序读取 `参数` sheet。

-   **导出记录**：将当日/当前会话的 `记录/帧日志/结果` 另存或附加到指定文件。

  

___

  

## 12\. 角色与权限

  

-   **工人**：只能看主界面，操作“一键/单步”，打开串口，导出记录；**不能**改工程师参数。

-   **工程师**：输入密码后可进入“工程师参数”弹窗，编辑寄存器映射、密码/操作者、长度规则等。

  

___

  

## 13\. 错误处理与边界

  

|     场景     |          行为          |

|------------|----------------------|

|   串口被占用    |    提示“端口占用”，不可打开     |

|     超时     |    记录超时、重试，超限后失败     |

|   CS 错误    |   标红记录包体，提示“校验和错误”   |

|  回包控制码异常   |     标红并提示“控制码不符”     |

|  步骤依赖未满足   |      禁用按钮或执行时报错      |

| Excel 写入失败 | 回滚本次写入，提示“请关闭文件或另存为” |

  

___

  

## 14\. 非功能需求（你要简单，我就把复杂度挡在我这里）

  

-   **易用**：单页、菜单弹窗、按钮直观、主区域只显示执行与日志；

-   **稳健**：串口严格状态机，发送/接收不可并发；

-   **性能**：单包往返 < 1.5s，整套“一键”在 30–60s 级别（视步骤数量与重试）；

-   **可维护**：协议常量、寄存器映射、长度规则**全部来源 Excel**，代码不硬编码；

-   **可移植**：仅依赖 PyQt5、pyserial、openpyxl。

  

___

  

## 15\. 交互细节（你不爱提，我替你做完）

  

-   **一键校表**：按左侧勾选顺序依次执行；中途失败若“策略=停止”，则停在失败步并高亮；若“策略=重试”，按 N 次重试后再停。

-   **单步执行**：独立按钮触发；成功后在该行显示“✓ 时间/耗时/主判据摘要”。

-   **日志呈现**：

    -   行首 `Tx>`/`Rx>` 明确方向；

    -   十六进制**两位分组、空格隔开**；

    -   CS 校验通过与否追加 `[CS OK] / [CS BAD]`；

    -   支持“复制当前行到剪贴板”。

  

___

  

## 16\. 测试大纲（是的，我懒得宠着侥幸心理）

  

-   **静态测试**：不接设备，模拟端口，验证组帧字节与 Excel `B32` 一致；验证 CS 与 Excel `C36` 一致；对 DI 与参数链路做随机值测试。

-   **联调测试**：逐步对照真实设备，确认每一步应答与业务判定可达“通过”；异常断电/拔线也要试。

-   **回归**：任何“工程师参数表”变更后，重跑静态用例，确认组帧一致性。

  

___

  

## 17\. 附录 A：模板提取的公式与字段（原样/等价说明）

  

> 我确实从你的 v2.0 sheet 里把能抓到的关键公式都抠出来了；**有些 LET 被 Excel 显示为 `_xlfn.LET(...)`，我已用算法文字还原**，这对实现等价逻辑足够了。

  

|   坐标   |                                            内容                                            |

|--------|------------------------------------------------------------------------------------------|

|  **B25**   |                           `68 11 11 11 11 11 11 68 14`（头部 + 控制码）                           |

|  **B26**   |                                    `33333333`（疑似密码域文本）                                     |

|  **B27**   |                                    `34333333`（疑似操作者码文本）                                    |

|  **C39**   |                                     `00F81500`（DI 原码）                                      |

|  **D39**   |  `=CONCATENATE(RIGHT(C39,2)," ",MID(C39,5,2)," ",MID(C39,3,2)," ",LEFT(C39,2))`（DI 翻字节序）   |

|  **E39**   |                           `LET(...)` 核心：逐字节 `+0x33` 偏置后拼接（见第 7.2）                            |

|  **B42**   |                                       `0`（示例业务参数十进制）                                       |

|  **C42**   |                                     `=DEC2HEX(B42,2)`                                      |

|  **D42**   |                       `=CONCATENATE(RIGHT(DEC2HEX(B42,8),2))`（取低字节）                        |

|  **E42**   |                             `LET(...)`：对 D42 的 HEX 字节 `+0x33` 偏置                             |

|  **B34**   |                    `=SUBSTITUTE(E42&E43&E44&E45&E46&E47," ","")`（数据域拼接）                    |

|  **C34**   | `=IF(LEN(DEC2HEX(LEN(B34)/2+12))=1,"0"&DEC2HEX(LEN(B34)/2+12),DEC2HEX(LEN(B34)/2+12))`（长度） |

|  **B36**   |                   `=SUBSTITUTE(B25&C34&E39&B26&B27&B34," ","")`（CS 参与段）                    |

|  **C36**   | `=DEC2HEX(MOD(SUM(HEX2DEC(MID(B36,(ROW(INDIRECT("1:"&LEN(B36)/2))-1)*2+1,2))),256),2)`（CS） |

|  **B32**   |                 `=SUBSTITUTE(B25&C34&E39&B26&B27&B34&C36&16," ","")`（最终帧）                  |

|   **F5**   |                                     `=180*6*1000`（Ra 计算）                                     |

| **F34 备注** |                                   `理由：在增益全部校准后，解决相位问题。`                                    |

  

> 若你还藏了其它 DI/参数段在 E43..E47、D43..D47 等，我的程序规范已经全部覆盖：**每段十进参数 → HEX → 取位/字节序 → +0x33 → 拼接**，你只要在 Excel 参数表里把每步“业务参数段构成”明确列出来即可。

  

___

  

## 18\. 附录 B：工程师“寄存器与数据项”映射表设计（Excel 结构）

  

|    字段    |                          示例                          |        说明         |

|----------|------------------------------------------------------|-------------------|

|   步骤名    |                         相位补偿                         |       UI 显示       |

|   操作类型   |                         写/读                          |      影响控制码选择      |

|  DI 原码   |                       00F81500                       |      C39 同构       |

|  业务参数来源  | `offset_value` / `gain_u` / `gain_i` / `phase_code` / `small_i_bias` | 程序从“标准值/计算值/输入框”取 |

|  业务参数编码  |         `UInt16LE@lowbyte` / `BCD6` / `IEEE754LE`          |    指定数值转字节的方式     |

| 是否 +0x33 |                          是                           |      大多是“是”       |

|   附加域    |                        密码/操作者                        |       按顺序拼接       |

|   长度规则   |                    `LEN(DATA) + 12`                    |       可在此覆写       |

  

> **你们厂的真实寄存器/编码规则**请自己填到这张表里；程序只做机械的“按规则组装”。

  

___

  

## 19\. 附录 C：一键校表策略

  

-   **失败即停**（默认）：一旦某一步失败，立即停止并高亮失败行；

-   **失败重试 N 次**：对当前步最多重试 N 次（间隔 T ms），仍失败则停；

-   **失败继续**：用于工程验证，不建议在产线开启。

  

___

  

## 20\. 交付清单

  

1.  PyQt5 可执行程序（Windows 打包，单文件/文件夹两种形态）；

2.  Excel 模板（含 `参数/记录/帧日志/结果` 四 sheet）；

3.  使用手册（工人版）+ 参数维护手册（工程师版）；

4.  源码与简短注释（组帧引擎、串口、UI、Excel I/O 分模块）。

  

___

  

## 21\. 实施节奏（里程碑）

  

| 里程碑 |           内容            |    交付     |

|-----|-------------------------|-----------|

| M1  | 框架搭建（UI 骨架、菜单、串口开关、日志区） | 可启动、可枚举串口 |

| M2  |   组帧引擎等价验证（对照 Excel）    |  单元测试截图   |

| M3  |        五步执行与一键策略        |   半成品演示   |

| M4  |      Excel 存档与参数导入      |   可持久化    |

| M5  |        异常/重试/权限         |   封版候选    |

| M6  |          现场联调           |    正式版    |

  

___


## 22\. 你关心的“简单”落地建议（防止你们在 PyQt5 里迷路）

  

-   UI 用 Qt Designer 拉出：顶部工具条、左树右日志、底状态栏；生成 `.ui` 再用 `pyuic` 转。

-   代码结构：

    -   `main.py`（入口）

    -   `ui_main.py`（由 .ui 生成）

    -   `serial_port.py`（pyserial 包装 + 状态机）

    -   `frame_builder.py`（DI 翻转、+0x33、CS、长度、拼接）

    -   `excel_io.py`（openpyxl：参数读、记录写）

    -   `steps.py`（五步的业务封装：拿数据→调 frame\_builder→发→收→判定）

-   依赖：`PyQt5`, `pyserial`, `openpyxl`。**没有别的**。

  

  
