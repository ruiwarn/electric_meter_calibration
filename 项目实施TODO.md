# RN8213/RN8211B 电表校准工具 v2.0 → PyQt5 实施TODO清单

> 基于需求文档《校表软件需求.md》和Excel模板《RN8211B V3校表计算.xlsx》
>
> 技术栈：PyQt5 + pyserial + openpyxl
>
> 目标：单页GUI + 串口校表 + Excel存档

---

## 📋 项目总体进度跟踪

### 已完成 ✅
- [x] 需求文档分析完成
- [x] Excel模板分析完成（仅作参考）
- [x] 关键算法和协议格式确认完成
- [x] 技术栈可行性确认
- [x] **M1**: 框架搭建完成 - UI骨架、菜单、串口功能、日志系统、对话框全部实现
- [x] **M2**: DL/T645帧构建引擎 - 算法独立实现，100%测试通过

### 待完成 📝
- [ ] **M3**: 校表执行引擎 - 五步校表逻辑、参数计算、设备通信
- [ ] **M4**: 数据管理系统 - 配置持久化、历史记录、报告生成
- [ ] **M5**: 生产环境优化 - 异常处理、重试机制、权限管理
- [ ] **M6**: 现场部署验证 - 实际设备测试、性能优化

---

## 🎯 M1阶段：框架搭建 ✅ 已完成 (实际用时1个对话)

### 1.1 项目结构初始化 🏗️ ✅
- [x] 创建项目目录结构
  ```
  electric_meter_calibration/
  ├── main.py                 # 程序入口
  ├── requirements.txt        # 依赖列表
  ├── src/
  │   ├── __init__.py
  │   ├── ui/
  │   │   ├── __init__.py
  │   │   ├── main_window.py  # 主窗口类
  │   │   ├── dialogs/        # 各种对话框
  │   │   └── resources.qrc   # Qt资源文件
  │   ├── core/
  │   │   ├── __init__.py
  │   │   ├── serial_port.py  # 串口通信
  │   │   ├── frame_builder.py # 报文构造
  │   │   ├── excel_io.py     # Excel读写
  │   │   └── steps.py        # 校表步骤
  │   └── config/
  │       ├── __init__.py
  │       └── settings.py     # 配置管理
  ├── ui_files/               # Qt Designer文件
  │   └── main_window.ui
  ├── templates/              # Excel模板
  │   └── calibration_template.xlsx
  └── docs/                   # 文档
      ├── 校表软件需求.md
      └── 项目实施TODO.md
  ```

### 1.2 依赖环境配置 📦 ✅
- [x] 创建 `requirements.txt` - PyQt5 + pyserial + openpyxl
- [x] 验证Python环境(3.13)
- [x] 安装依赖包测试 - 全部成功

### 1.3 Qt Designer UI设计 🎨 ✅
- [x] **主窗口布局设计** - 代码实现(无需ui文件)
  - [x] 顶部工具条 - 一键校表、串口控制、状态灯
  - [x] 中央分割布局 - 左步骤区+右日志区
  - [x] 5个校表步骤控件 - 复选框+执行按钮+结果显示
  - [x] 通信日志区域 - Tx/Rx格式、自动滚动
  - [x] 底部状态栏 - 串口参数+标准值摘要

- [x] **菜单栏设计** - 完整5级菜单
  - [x] 文件菜单 - 载入模板/导出记录/退出
  - [x] 通讯菜单 - 串口配置/端口探测
  - [x] 参数菜单 - 标准值输入/工程师参数
  - [x] 自动化菜单 - 步骤模板/执行策略
  - [x] 帮助菜单 - 使用说明/关于

### 1.4 对话框设计 💬 ✅
- [x] **串口配置对话框** - 全功能实现
  - [x] 端口选择+刷新、波特率、数据位、校验位、停止位
  - [x] 读写超时、重试次数、帧间隔配置
  - [x] 参数验证和保存

- [x] **标准值输入对话框** - 全功能实现
  - [x] 标准电压(90-300V)、标准电流(0-200A)
  - [x] 功率误差(±10%)、误差校准模式
  - [x] 实时范围验证和错误提示

### 1.5 主窗口基础逻辑 🔧 ✅
- [x] **MainWindow类实现** - 完整功能
  - [x] PyQt5代码实现(无需ui文件)
  - [x] 完整信号槽连接
  - [x] 菜单、按钮、步骤事件处理
  - [x] 状态管理和UI更新

- [x] **对话框集成** - 完整集成
  - [x] SerialConfigDialog - 可正常打开配置
  - [x] StandardValuesDialog - 可正常设置标准值
  - [x] 参数保存和状态栏更新

### 1.6 串口基础功能 📡 ✅
- [x] **SerialPort类实现** - 完整功能
  - [x] 4状态状态机(关闭/打开/忙碌/错误)
  - [x] 端口枚举功能 - 支持多平台
  - [x] DL/T645帧结构支持
  - [x] 线程安全设计

- [x] **串口控制集成** - 完整集成
  - [x] 主窗口状态指示灯
  - [x] 端口探测功能
  - [x] 状态栏显示

### 1.7 日志系统基础 📝 ✅
- [x] **CalibrationLogger类** - 完整功能
  - [x] Tx>/Rx>格式显示
  - [x] 十六进制空格分隔
  - [x] 时间戳和自动滚动
  - [x] DL/T645帧分析

- [x] **日志记录类** - 完整功能
  - [x] 分级日志记录
  - [x] 帧日志专用处理
  - [x] 内存限制管理

### 1.8 M1阶段集成测试 🧪 ✅
- [x] **完整测试通过** - test_m1_framework.py
  - [x] 程序正常启动 ✅
  - [x] 所有UI控件正常显示 ✅
  - [x] 菜单和对话框正常弹出 ✅
  - [x] 串口枚举功能正常 ✅
  - [x] Excel模板读取正常 ✅

### 1.9 M1阶段问题修复 🔧 ✅
- [x] **导入路径问题** - 修复相对导入超出顶级包错误
- [x] **Qt高DPI设置** - 移到QApplication创建前
- [x] **状态同步问题** - 修复串口配置与状态栏显示不一致
- [x] **防错设计** - 未配置串口时的操作提示

### 1.10 M1阶段手动测试 🧪 ✅ (进行中)
- [x] **标准值对话框测试** - 数值验证、模式切换、配置保存恢复 ✅
- [x] **串口配置对话框测试** - 参数设置、端口选择、刷新功能 ✅
- [x] **串口状态管理测试** - 真实开关、冲突检测、状态同步 ✅
- [x] **用户体验优化** - 默认参数9600、自动配置引导 ✅
- [x] **端口探测功能测试** - 端口枚举、刷新操作 ✅
- [ ] **校表步骤模拟测试** - 单步执行、一键校表、状态显示
- [ ] **日志系统测试** - 格式、时间戳、滚动、内容完整性
- [ ] **菜单系统完整性测试** - 所有菜单项、功能提示

---

## 🎯 M2阶段：组帧引擎等价验证 (预计2-3个对话完成)

### 2.1 Excel公式逆向工程 🔍
- [ ] **关键公式提取与分析**
  - [ ] 提取B32最终帧拼接公式
  - [ ] 提取D39 DI字节序翻转公式
  - [ ] 提取E39 +0x33偏置公式
  - [ ] 提取C34长度计算公式
  - [ ] 提取C36校验和计算公式
  - [ ] 提取B34数据域拼接公式

- [ ] **算法等价性验证**
  - [ ] Python实现vs Excel公式对比
  - [ ] 使用Excel测试数据验证
  - [ ] 边界情况测试
  - [ ] 特殊字符处理测试

### 2.2 FrameBuilder核心引擎 ⚙️
- [ ] **FrameBuilder类设计** (`src/core/frame_builder.py`)
  - [ ] DI字节序翻转算法
    ```python
    def reverse_di_bytes(di_hex_string):
        # 实现 abcdefgh -> "gh ef cd ab"
    ```
  - [ ] 0x33偏置算法
    ```python
    def apply_0x33_offset(hex_bytes):
        # 实现每字节 +0x33 & 0xFF
    ```
  - [ ] 长度L计算
    ```python
    def calculate_length(data_len):
        # 实现 L = data_len + 12
    ```
  - [ ] 校验和CS计算
    ```python
    def calculate_checksum(frame_segment):
        # 实现从第二个0x68到数据域末尾求和 mod 256
    ```
  - [ ] 完整帧构造
    ```python
    def build_complete_frame(di, business_data, password, operator):
        # 实现完整的组帧逻辑
    ```

### 2.3 单元测试验证 🧪
- [ ] **测试数据对比**
  - [ ] 使用Excel中的C39="00F81500"测试DI翻转
  - [ ] 验证D39结果："00 15 F8 00"
  - [ ] 验证E39结果："33482B33"
  - [ ] 测试B42=0的完整组帧流程
  - [ ] 验证最终B32帧结果

- [ ] **边界测试**
  - [ ] 空数据域测试
  - [ ] 最大长度数据域测试
  - [ ] 特殊字符(0x00, 0xFF)测试
  - [ ] 校验和溢出测试

### 2.4 帧解析引擎 📥
- [ ] **FrameParser类设计**
  - [ ] 帧起始符搜索 (0x68)
  - [ ] 帧结构解析 (地址+控制码+长度+数据+CS+结束符)
  - [ ] 校验和验证
  - [ ] 控制码验证
  - [ ] 数据域反偏置 (-0x33 & 0xFF)
  - [ ] 业务数据提取

### 2.5 Excel数据驱动测试 📊
- [ ] **测试数据管理**
  - [ ] 从Excel提取测试案例
  - [ ] 参数化测试框架
  - [ ] 自动化对比验证
  - [ ] 测试报告生成

---

## 🎯 M3阶段：五步执行与一键策略 (预计3-4个对话完成)

### 3.1 校表步骤抽象设计 📋
- [ ] **CalibrationStep基类**
  - [ ] 步骤元数据 (name, description, di_code)
  - [ ] 执行前检查 (依赖验证、参数验证)
  - [ ] 执行逻辑 (构造帧→发送→接收→验证)
  - [ ] 结果判定 (成功/失败/需重试)
  - [ ] 日志记录 (详细执行日志)

### 3.2 五大校表步骤实现 🔧
- [ ] **Step1: 电流有效值offset校正**
  - [ ] 空载条件检查 (I=0, U=Un)
  - [ ] IARMSOS寄存器写入
  - [ ] 回读验证和阈值检查
  - [ ] 成功判定逻辑

- [ ] **Step2: 1.0L标准电压电流校正**
  - [ ] 标准值依赖检查 (U=220V, I=64A)
  - [ ] UGain, IAGain寄存器写入
  - [ ] 多寄存器写入策略
  - [ ] 线性增益验证

- [ ] **Step3: 功率增益校正**
  - [ ] 功率计算 (U×I×PF)
  - [ ] 误差模式支持
  - [ ] GPQA寄存器写入
  - [ ] 功率常数验证

- [ ] **Step4: 相位补偿校正**
  - [ ] 前置步骤依赖检查
  - [ ] PhsA寄存器写入
  - [ ] 相位误差验证
  - [ ] 功率因数检查

- [ ] **Step5: 小电流有功偏置校正**
  - [ ] 小电流条件 (5%Ib)
  - [ ] APOSA寄存器写入
  - [ ] 小信号区域验证
  - [ ] 非线性误差补偿

### 3.3 步骤管理器 📊
- [ ] **StepManager类**
  - [ ] 步骤注册和管理
  - [ ] 依赖关系检查
  - [ ] 执行顺序控制
  - [ ] 状态跟踪和恢复

### 3.4 串口通信集成 📡
- [ ] **串口发送逻辑**
  - [ ] 帧数据转换 (hex string → bytes)
  - [ ] 发送确认和超时处理
  - [ ] 发送日志记录

- [ ] **串口接收逻辑**
  - [ ] 帧起始符搜索
  - [ ] 按长度读取完整帧
  - [ ] 接收超时处理
  - [ ] 接收日志记录

### 3.5 执行策略实现 ⚡
- [ ] **单步执行模式**
  - [ ] 独立步骤触发
  - [ ] 实时状态更新
  - [ ] 错误处理和显示

- [ ] **一键校表模式**
  - [ ] 勾选步骤收集
  - [ ] 按序自动执行
  - [ ] 失败策略处理：
    - [ ] 失败即停 (默认)
    - [ ] 失败重试N次
    - [ ] 失败继续 (工程模式)

### 3.6 实时UI更新 🔄
- [ ] **步骤状态显示**
  - [ ] 执行中状态 (进度条/spinner)
  - [ ] 成功状态 (✓ + 结果摘要)
  - [ ] 失败状态 (✗ + 错误信息)
  - [ ] 耗时显示

- [ ] **日志实时更新**
  - [ ] Tx/Rx帧实时显示
  - [ ] 校验结果标识 [CS OK/BAD]
  - [ ] 控制码验证结果
  - [ ] 执行耗时统计

---

## 🎯 M4阶段：Excel存档与参数导入 (预计2-3个对话完成)

### 4.1 Excel I/O引擎设计 📗
- [ ] **ExcelIO类实现** (`src/core/excel_io.py`)
  - [ ] 工作簿结构管理
  - [ ] 多Sheet读写操作
  - [ ] 数据类型自动转换
  - [ ] 异常处理和恢复

### 4.2 工作簿结构设计 📋
- [ ] **参数Sheet (Parameters)**
  - [ ] 工程师参数表
    - [ ] 基准电压Un、电阻Ra、增益等
    - [ ] 寄存器映射表 (DI→参数→编码规则)
    - [ ] 报文模板规则
  - [ ] 标准值配置
  - [ ] 串口配置历史

- [ ] **记录Sheet (Records)**
  - [ ] 校表记录表头：时间、操作员、型号、步骤、结论
  - [ ] 每次校表操作记录
  - [ ] 批次统计信息

- [ ] **帧日志Sheet (FrameLog)**
  - [ ] 表头：时间、步骤、方向、原始帧、CS验证、耗时、异常
  - [ ] 原始Tx/Rx十六进制记录
  - [ ] 详细通信日志

- [ ] **结果Sheet (Results)**
  - [ ] 表头：步骤名、目标值、读回值、阈值、通过状态
  - [ ] 每步校表结果记录
  - [ ] 数值对比和偏差分析

### 4.3 参数导入功能 📥
- [ ] **模板加载**
  - [ ] Excel文件选择和验证
  - [ ] 参数Sheet解析
  - [ ] 工程师参数加载到内存
  - [ ] 参数合法性检查

- [ ] **配置应用**
  - [ ] 串口配置应用
  - [ ] 标准值配置应用
  - [ ] 寄存器映射表加载
  - [ ] UI状态更新

### 4.4 实时记录功能 📝
- [ ] **操作记录**
  - [ ] 校表开始/结束时间记录
  - [ ] 操作员信息记录
  - [ ] 设备型号和批次记录
  - [ ] 步骤执行记录

- [ ] **帧日志记录**
  - [ ] 每次Tx/Rx实时记录
  - [ ] 校验结果记录
  - [ ] 异常情况记录
  - [ ] 性能统计记录

### 4.5 导出存档功能 📤
- [ ] **记录导出**
  - [ ] 当日记录导出
  - [ ] 指定时间范围导出
  - [ ] 按设备批次导出
  - [ ] 多种格式支持 (Excel, CSV)

- [ ] **数据备份**
  - [ ] 自动备份策略
  - [ ] 增量备份逻辑
  - [ ] 备份文件管理

---

## 🎯 M5阶段：异常/重试/权限 (预计2个对话完成)

### 5.1 异常处理体系 ⚠️
- [ ] **串口异常处理**
  - [ ] 端口占用异常
  - [ ] 连接断开异常
  - [ ] 读写超时异常
  - [ ] 参数配置异常

- [ ] **通信异常处理**
  - [ ] CS校验错误
  - [ ] 控制码不符
  - [ ] 帧格式错误
  - [ ] 响应超时

- [ ] **业务异常处理**
  - [ ] 步骤依赖未满足
  - [ ] 参数范围越界
  - [ ] 读回值验证失败
  - [ ] Excel文件锁定

### 5.2 重试策略实现 🔄
- [ ] **重试配置**
  - [ ] 重试次数设置 (默认2次)
  - [ ] 重试间隔设置 (默认200ms)
  - [ ] 重试条件配置

- [ ] **智能重试**
  - [ ] 临时性错误重试 (超时、CS错误)
  - [ ] 永久性错误不重试 (端口占用、参数错误)
  - [ ] 重试历史记录
  - [ ] 重试成功率统计

### 5.3 权限管理系统 🔐
- [ ] **角色定义**
  - [ ] 工人角色：只能操作主界面、导出记录
  - [ ] 工程师角色：可修改工程师参数

- [ ] **密码验证**
  - [ ] 工程师密码设置和验证
  - [ ] 会话超时处理
  - [ ] 权限状态显示

- [ ] **功能权限控制**
  - [ ] 菜单项权限控制
  - [ ] 参数编辑权限控制
  - [ ] 敏感操作记录

### 5.4 状态管理优化 📊
- [ ] **状态机完善**
  - [ ] 系统状态：未连接/已连接/校表中/异常
  - [ ] 步骤状态：待执行/执行中/成功/失败/跳过
  - [ ] 状态转换逻辑

- [ ] **状态持久化**
  - [ ] 会话状态保存
  - [ ] 异常恢复机制
  - [ ] 状态历史记录

---

## 🎯 M6阶段：现场联调 (预计1-2个对话完成)

### 6.1 现场部署准备 🚀
- [ ] **打包发布**
  - [ ] PyInstaller打包配置
  - [ ] 单文件/文件夹两种形态
  - [ ] 依赖库打包验证
  - [ ] Windows兼容性测试

- [ ] **部署包组成**
  - [ ] 可执行程序
  - [ ] Excel模板文件
  - [ ] 配置文件模板
  - [ ] 用户手册

### 6.2 联调测试计划 🧪
- [ ] **设备连接测试**
  - [ ] 真实设备串口连接
  - [ ] 通信参数调优
  - [ ] 协议兼容性验证

- [ ] **校表流程验证**
  - [ ] 五步校表完整流程
  - [ ] 一键校表稳定性
  - [ ] 异常情况处理

- [ ] **生产环境测试**
  - [ ] 产线环境适应性
  - [ ] 长时间运行稳定性
  - [ ] 多台设备并发测试

### 6.3 文档完善 📚
- [ ] **用户手册 (工人版)**
  - [ ] 软件安装和启动
  - [ ] 基本操作流程
  - [ ] 常见问题解决

- [ ] **工程师手册**
  - [ ] 参数配置说明
  - [ ] 高级功能使用
  - [ ] 故障诊断指南

- [ ] **技术文档**
  - [ ] 系统架构说明
  - [ ] 接口协议文档
  - [ ] 二次开发指南

---

## 📝 开发注意事项

### 代码质量要求
- [ ] 遵循PEP8代码规范
- [ ] 添加必要的注释和文档字符串
- [ ] 异常处理覆盖全面
- [ ] 日志记录详细完整

### 性能要求
- [ ] 单包往返 < 1.5s
- [ ] 整套一键校表 30-60s
- [ ] UI响应 < 100ms
- [ ] 内存使用合理

### 安全要求
- [ ] 不暴露敏感信息
- [ ] 不记录密码到日志
- [ ] Excel文件安全读写
- [ ] 参数范围严格验证

### 可维护性
- [ ] 模块边界清晰
- [ ] 配置参数外部化
- [ ] 错误信息清晰
- [ ] 代码结构简洁

---

## 🔄 多对话协作机制

### 进度跟踪
- 每个对话开始时检查TODO状态
- 完成项目及时标记 ✅
- 阻塞问题及时记录和跟进

### 代码传承
- 关键代码模块独立文件保存
- 重要设计决策记录到文档
- 接口规范明确定义

### 测试策略
- 每个阶段都有独立测试
- 回归测试保证质量
- 现场问题快速定位

---

**备注**: 此TODO文档会随着开发进展持续更新，每个对话都会基于当前状态继续推进。预计总共需要 10-15 个对话完成整个项目的开发和联调。